<?php
session_start();
include("Database/connection.php");

// Redirect to index.php if user is not logged in
if (!isset($_SESSION['user_id'])) {
    header("location: index");
    exit();
}

$user_id = $_SESSION['user_id'];

// Check if the form is submitted
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    // Retrieve form data
    $id = $_POST["id"]; // Assuming you're passing the user ID in the form as a hidden input
    $firstname = $_POST["Fname"];
    $lastname = $_POST["Lastname"];
    $email = $_POST["email"];
    $phone_no = $_POST["Contact"];
    $updateStCV = $_FILES["updateStCV"]["name"] ? basename($_FILES["updateStCV"]["name"]) : '';

    // Handle file upload for profile image
    $profile = null;
    if (isset($_FILES["editCompanyLogo"]) && $_FILES["editCompanyLogo"]["error"] == 0) {
        $target_dir = "userDashboards/uploads/profiles/";
        $target_file = $target_dir . basename($_FILES["editCompanyLogo"]["name"]);
        if (move_uploaded_file($_FILES["editCompanyLogo"]["tmp_name"], $target_file)) {
            $profile = basename($_FILES["editCompanyLogo"]["name"]);
        } else {
            echo "Sorry, there was an error uploading your profile image.";
            exit();
        }
    }

    // Handle file upload for CV
    if (isset($_FILES["updateStCV"]) && $_FILES["updateStCV"]["error"] == 0) {
        $cv_target_dir = "resumes/";
        $cv_target_file = $cv_target_dir . basename($_FILES["updateStCV"]["name"]);
        if (!move_uploaded_file($_FILES["updateStCV"]["tmp_name"], $cv_target_file)) {
            echo "Sorry, there was an error uploading your CV.";
            exit();
        }
    }

    // SQL query to update data in the database using prepared statements
    $sql = "UPDATE userregister SET 
            firstname = ?, 
            lastname = ?, 
            email = ?, 
            phone_no = ?,
            studentCV = ?";

    // Append profile update if a new profile was uploaded
    if ($profile !== null) {
        $sql .= ", profile = ?";
    }

    $sql .= " WHERE id = ?";

    $stmt = $conn->prepare($sql);
    if ($profile !== null) {
        $stmt->bind_param("ssssssi", $firstname, $lastname, $email, $phone_no, $updateStCV, $profile, $id);
    } else {
        $stmt->bind_param("sssssi", $firstname, $lastname, $email, $phone_no, $updateStCV, $id);
    }

    // Execute SQL query
    if ($stmt->execute() === TRUE) {
        $_SESSION['message'] = "Profile updated successfully";
        header("location: profile");
        exit();
    } else {
        echo "Error updating record: " . $stmt->error;
    }

    // Close the connection
    $stmt->close();
    $conn->close();
}
?>


<script>
        <?php

        // messages from corect or not 

        if (isset($_SESSION['message'])) {
        ?>
            alertify.set('notifier', 'position', 'top-right');
            alertify.success('<?= $_SESSION['message'] ?>');
        <?php
            unset($_SESSION['message']);
        }
        ?>
    </script>

















<!-- ------------------------- image upload section ------------------ -->
// Check if the file upload for profile image exists and is successful
            if (isset($_FILES["editCompanyLogo"]) && $_FILES["editCompanyLogo"]["error"] === UPLOAD_ERR_OK) {
                // Define target directory and file
                $target_dir = "userDashboards/uploads/profiles/";
                $target_file = $target_dir . basename($_FILES["editCompanyLogo"]["name"]);
                $imageFileType = strtolower(pathinfo($target_file, PATHINFO_EXTENSION));

                // Check if the file is an actual image
                $check = getimagesize($_FILES["editCompanyLogo"]["tmp_name"]);
                if ($check === false) {
                    echo "File is not an image.";
                    exit(); // Exit the script if the file is not an image
                }

                // Check file size (limit to 500KB)
                if ($_FILES["editCompanyLogo"]["size"] > 500000) {
                    echo "Sorry, your file is too large.";
                    exit(); // Exit the script if the file is too large
                }

                // Allow only certain file formats
                $allowed_formats = ["jpg", "jpeg", "png", "gif"];
                if (!in_array($imageFileType, $allowed_formats)) {
                    echo "Sorry, only JPG, JPEG, PNG & GIF files are allowed.";
                    exit(); // Exit the script if the file format is not allowed
                }

                // Move the uploaded file to the target directory
                if (move_uploaded_file($_FILES["editCompanyLogo"]["tmp_name"], $target_file)) {
                    // File upload successful, update the database with the new profile image path
                    $sql = "UPDATE userregister SET profile=? WHERE id=?";
                    $stmt = $conn->prepare($sql);
                    $stmt->bind_param("si", $target_file, $user_id);
                    if ($stmt->execute() === TRUE) {
                        echo "Profile image updated successfully.";
                    } else {
                        echo "Error updating profile image: " . $stmt->error;
                    }
                    $stmt->close();
                } else {
                    echo "Sorry, there was an error uploading your file.";
                }
            } else {
                echo "No file uploaded or an error occurred during upload.";
            }

